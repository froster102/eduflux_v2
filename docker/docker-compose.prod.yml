name: eduflux-services

services:
  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:4.1.4-management
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    ports:
      - 15672:15672
      - 5672:5672
    restart: on-failure
    networks:
      - eduflux-network

  redis:
    container_name: redis
    image: redis:8.0-M04-alpine
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    networks:
      - eduflux-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Application Services
  analytics-service:
    container_name: analytics-service
    build:
      context: ..
      dockerfile: apps/analytics-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/analytics-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  auth-service:
    container_name: auth-service
    build:
      context: ..
      dockerfile: apps/auth-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/auth-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      redis:
        condition: service_healthy

  user-service:
    container_name: user-service
    build:
      context: ..
      dockerfile: apps/user-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/user-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  course-service:
    container_name: course-service
    build:
      context: ..
      dockerfile: apps/course-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/course-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  payment-service:
    container_name: payment-service
    build:
      context: ..
      dockerfile: apps/payment-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/payment-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  session-service:
    container_name: session-service
    build:
      context: ..
      dockerfile: apps/session-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/session-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  chat-service:
    container_name: chat-service
    build:
      context: ..
      dockerfile: apps/chat-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/chat-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  checkout-service:
    container_name: checkout-service
    build:
      context: ..
      dockerfile: apps/checkout-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/checkout-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  notification-service:
    container_name: notification-service
    build:
      context: ..
      dockerfile: apps/notification-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/notification-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy

  upload-service:
    container_name: upload-service
    build:
      context: ..
      dockerfile: apps/upload-service/Dockerfile
    restart: unless-stopped
    env_file:
      - ../apps/upload-service/.env.production
    networks:
      - eduflux-network
    depends_on:
      redis:
        condition: service_healthy

  gateway:
    container_name: gateway
    build:
      context: ..
      dockerfile: apps/gateway/Dockerfile
    ports:
      - "8000:8000"
    restart: unless-stopped
    env_file:
      - ../apps/gateway/.env.production
    networks:
      - eduflux-network
    depends_on:
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      course-service:
        condition: service_started
      payment-service:
        condition: service_started
      session-service:
        condition: service_started
      chat-service:
        condition: service_started
      checkout-service:
        condition: service_started
      notification-service:
        condition: service_started
      upload-service:
        condition: service_started
      analytics-service:
        condition: service_started
    # Gateway uses Node.js base image, so health check is available
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3012/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  authdb_data:
  eduflux_db_data:
  redis_data:


networks:
  eduflux-network:
    driver: bridge
