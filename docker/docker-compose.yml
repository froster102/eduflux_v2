name: eduflux

services:

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    command: [ "http", "kong:8000", "--domain=${NGROK_STATIC_DOMAIN}", "--log=stdout" ]
    ports:
      - "4040:4040"
    networks:
      - eduflux-network
    restart: "no"

  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:4.1.4-management
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    ports:
      - 15672:15672
      - 5672:5672
    restart: on-failure

  eduflux_auth_db:
    container_name: eduflux_auth_db
    image: postgres:17
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgrespass
      - POSTGRES_DB=eduflux_auth_db
    ports:
      - 5432:5432
    networks:
      - eduflux-network
    volumes:
      - authdb_data:/var/lib/postgresql/data

  eduflux_db:
    container_name: eduflux_db
    image: mongo:8.0
    volumes:
      - eduflux_db_data:/data/db
    ports:
      - "27017:27017"
    command: [ "--replSet", "rs0" ]
    networks:
      - eduflux-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongo-init:
    image: mongo:8.0
    restart: "no"
    depends_on:
      eduflux_db:
        condition: service_healthy
    command: >
      mongosh --host eduflux_db:27017 --eval ' rs.initiate( {
         _id : "rs0",
         members: [
            { _id: 0, host: "localhost:27017" }
         ]
      }) '

  redis:
    container_name: redis
    image: redis:8.0-M04-alpine
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    environment:
      - REDIS_ARGS="--requirepass root_password"
    networks:
      - eduflux-network

  kafka:
    container_name: kafka
    image: 'bitnami/kafka:latest'
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@localhost:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092,CONTROLLER://kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKAJS_NO_PARTITIONER_WARNING=1
    networks:
      - eduflux-network
    volumes:
      - kafka_data:/bitnami/kafka
    ports:
      - 9092:9092
    healthcheck:
      test: [ "CMD", "kafka-topics.sh", "--bootstrap-server", "kafka:9092", "--list" ]
      interval: 10s
      timeout: 10s
      retries: 10
    # loki:
    #   container_name: loki
    #   image: grafana/loki:latest
    #   ports:
    #     - "3100:3100"
    #   command: -config.file=/etc/loki/local-config.yaml
    #   networks:
    #     - eduflux-network

    # promtail:
    #   container_name: promtail
    #   image: grafana/promtail:latest
    #   volumes:
    #     - /var/log:/var/log
    #   command: -config.file=/etc/promtail/config.yml
    #   networks:
    #     - eduflux-network

    # grafana:
    #   container_name: grafana
    #   environment:
    #     - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    #     - GF_AUTH_ANONYMOUS_ENABLED=true
    #     - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    #     - GF_FEATURE_TOGGLES_ENABLE=alertingSimplifiedRouting,alertingQueryAndExpressionsStepMode
    #   entrypoint:
    #     - sh
    #     - -euc
    #     - |
    #       mkdir -p /etc/grafana/provisioning/datasources
    #       cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
    #       apiVersion: 1
    #       datasources:
    #       - name: Loki
    #         type: loki
    #         access: proxy
    #         orgId: 1
    #         url: http://loki:3100
    #         basicAuth: false
    #         isDefault: true
    #         version: 1
    #         editable: false
    #       EOF
    #       /run.sh
    #   image: grafana/grafana:latest
    #   ports:
    #     - "4000:4000"
    #   networks:
    #     - eduflux-network

volumes:
  authdb_data:
  eduflux_db_data:
  eduflux_auth_db_data:
  redis_data:
  kafka_data:


networks:
  eduflux-network:
    driver: bridge
